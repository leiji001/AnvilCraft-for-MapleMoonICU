name: Build and Rename Modpack on Release

on:
  release:
    types: [published]  # ä»…åœ¨å‘å¸ƒ Release æ—¶è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸ“¦ Download Pakku Jar
        run: |
          curl -L -o pakku.jar https://github.com/juraj-hrivnak/Pakku/releases/download/v1.2.1/pakku.jar

      - name: ğŸ”¨ Run Pakku export
        run: |
          java -jar pakku.jar export

      - name: ğŸ“› Rename build outputs
        run: |
          mkdir renamed
          cp build/modrinth/*.mrpack     renamed/MMICU-AnvilCraft-Modrinth.mrpack
          cp build/curseforge/*.zip      renamed/MMICU-AnvilCraft-CurseForge.zip
          cp build/serverpack/*.zip      renamed/MMICU-AnvilCraft-ServerPack.zip

      - name: ğŸš€ Upload renamed artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            renamed/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ” Update server-dist branch (via .gitignore)
        run: |
          echo "ğŸ“¥ å…‹éš† server-dist åˆ†æ”¯"
          git clone --single-branch --branch server-dist \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} \
            server-content

          echo "ğŸ§¹ æ¸…é™¤æ—§æ–‡ä»¶ï¼ˆä¿ç•™ .gitï¼‰"
          cd server-content
          find . -mindepth 1 -not -name ".git" -exec rm -rf {} +
          cd ..

          echo "ğŸ“¦ è§£å‹ serverpack åˆ° server-content/"
          unzip -q build/serverpack/*.zip -d server-content

          echo "ğŸ”§ æäº¤å¹¶æ¨é€ mods/config åˆ° server-dist"
          cd server-content
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Update mods/config for ${{ github.ref_name }}" || echo "Nothing to commit"
          git push origin server-dist
