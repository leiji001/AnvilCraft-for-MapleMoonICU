name: Build and Rename Modpack on Release

on:
  release:
    types: [published]  # 仅在发布 Release 时触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 📦 Download Pakku Jar
        run: |
          curl -L -o pakku.jar https://github.com/juraj-hrivnak/Pakku/releases/download/v1.2.1/pakku.jar

      - name: 🔨 Run Pakku export
        run: |
          java -jar pakku.jar export

      - name: 📛 Rename build outputs
        run: |
          mkdir renamed
          cp build/modrinth/*.mrpack     renamed/MMICU-AnvilCraft-Modrinth.mrpack
          cp build/curseforge/*.zip      renamed/MMICU-AnvilCraft-CurseForge.zip
          cp build/serverpack/*.zip      renamed/MMICU-AnvilCraft-ServerPack.zip

      - name: 🚀 Upload renamed artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            renamed/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 🔁 Update server-dist branch (via .gitignore)
        run: |
          echo "📥 克隆 server-dist 分支"
          git clone --single-branch --branch server-dist \
            https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} \
            server-content

          echo "🧹 清除旧文件（保留 .git）"
          cd server-content
          find . -mindepth 1 -not -name ".git" -exec rm -rf {} +
          cd ..

          echo "📦 解压 serverpack 到 server-content/"
          unzip -q build/serverpack/*.zip -d server-content

          echo "🔧 提交并推送 mods/config 到 server-dist"
          cd server-content
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Update mods/config for ${{ github.ref_name }}" || echo "Nothing to commit"
          git push origin server-dist
